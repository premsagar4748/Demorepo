import { Sharedservice } from '../../../../Core/Providers/Shared/sharedservice';
import { SharedModule } from '../../../../Core/Providers/Shared/shared.module';
import { Component, ViewChild, ElementRef, HostListener, SimpleChanges } from '@angular/core';
// import { Subscription } from 'rxjs';
import { Setdates } from '../../../../Core/Providers/SetDates/setdates';
import { BsDatepickerModule } from 'ngx-bootstrap/datepicker';
import { common } from '../../../../common';
import { Stores } from '../../../../CommonFilters/stores/stores';
import { DateRangePicker } from '../../../../CommonFilters/date-range-picker/date-range-picker';

@Component({
  selector: 'app-dashboard',
  imports: [SharedModule, BsDatepickerModule, Stores, DateRangePicker],
  standalone: true,
  templateUrl: './dashboard.html',
  styleUrl: './dashboard.scss'
})
export class Dashboard {
  SalesPersonsData: any = [];
  FIManagerData: any = [];
  TotalSalesPersonsData: any = [];
  FromDate: any='';
  ToDate: any='';
  NoData: boolean = false;
  path1: any = '';
  path2: any = '';
  path3: any = '';
  TotalReport: any = 'T';
  storeIds: any = '0';
  CompleteComponentState: boolean = true;
  dateType: any = 'MTD';
  dealType: any = 'New,Used';
  saleType: any = 'Retail,Lease,Misc,Special Order';
  financeType: any = 'Finance,Cash,Lease';
  storeorgrp: any = 'G';
  groups: any = 8;


  stores: any = []
  groupsArray: any = [];
  storename: any = ''
  storecount: any = null;
  storedisplayname: any = '';
  groupName: any = '';
  groupId: any = 8;

  storesFilterData: any = {
    'groupsArray': this.groupsArray, 'groupId': this.groupId, 'storesArray': this.stores, 'storeids': '1', 'type': 'M', 'others': 'N',
    'groupName': this.groupName, 'storename': this.storename, storecount: null, 'storedisplayname': this.storedisplayname
  };


  header: any = [{
    type: 'Bar', storeIds: this.storeIds, storeorgroup: this.storeorgrp, dealType: this.dealType,
    saleType: this.saleType,
    financeType: this.financeType, groups: this.groups
  }]
  popup: any = [{ type: 'Popup' }];

  // solutionurl: any = this.shared.getEnviUrl();
  LogCount = 1;
  




  columnName: any = 'Rank';
  columnState: any = 'asc';
  dealStatus: any;
  displaytime:any=''
  DateType: string = 'MTD';
  custom: boolean = false;
  // FromDate: any;
  // ToDate: any;
  bsRangeValue!: Date[];
  minDate: Date=new Date();
  maxDate: Date= new Date();

  Dates: any = {
    'FromDate': this.FromDate, 'ToDate': this.ToDate, "MaxDate": this.maxDate, 'MinDate': this.minDate, 'DateType': this.DateType, 'DisplayTime': this.displaytime,
    Types: [
      { 'code': 'MTD', 'name': 'MTD' },
      { 'code': 'YTD', 'name': 'YTD' },
      { 'code': 'PYTD', 'name': 'PYTD' },
      { 'code': 'LM', 'name': 'Last Month' },
      { 'code': 'PM', 'name': 'Same Month PY' },
    ]
  }

  constructor(
    public shared: Sharedservice, public setdates: Setdates, private comm: common,
  ) {
    // this.initializeDates();
    this.shared.setTitle(this.shared.common.titleName + 'F&I Manager Ranking');
    // this.GetData(this.columnName, this.columnState);

    // let today = new Date();
    // let enddate = new Date(today.setDate(today.getDate() - 1));
    // this.FromDate =
    //   ('0' + (enddate.getMonth() + 1)).slice(-2) +
    //   '-01' +
    //   '-' +
    //   enddate.getFullYear();
    // this.ToDate =
    //   ('0' + (enddate.getMonth() + 1)).slice(-2) +
    //   '-' +
    //   ('0' + enddate.getDate()).slice(-2) +
    //   '-' +
    //   enddate.getFullYear();
    // this.FromDate = this.FromDate.replace(/-/g, '/');
    // this.ToDate = this.ToDate.replace(/-/g, '/');
    // this.shared.setTitle(this.shared.common.titleName+'-F&I Manager Ranking');
    if (typeof window !== 'undefined') {
      if (localStorage.getItem('flag') == 'V') {
        this.storeIds=[];
        console.log(JSON.parse(localStorage.getItem('userInfo')!), JSON.parse(localStorage.getItem('userInfo')!).user_Info, 'Widget Stores............');
        JSON.parse(localStorage.getItem('userInfo')!).user_Info.widgetStores.indexOf(',') > 0 ?
          this.storeIds = JSON.parse(localStorage.getItem('userInfo')!).user_Info.widgetStores.split(',') :
          this.storeIds.push(JSON.parse(localStorage.getItem('userInfo')!).user_Info.widgetStores)

      }

      else if (localStorage.getItem('userInfo') != null && localStorage.getItem('userInfo') != undefined) {
        JSON.parse(localStorage.getItem('userInfo')!).user_Info.ustores.indexOf(',') > 0 ?
          this.storeIds = JSON.parse(localStorage.getItem('userInfo')!).user_Info.ustores.split(',') :
          this.storeIds.push(JSON.parse(localStorage.getItem('userInfo')!).user_Info.ustores)
      }
      if (this.shared.common.groupsandstores.length > 0) {
        this.groupsArray = this.shared.common.groupsandstores.filter((val: any) => val.sg_id != this.shared.common.reconID);
        this.stores = this.shared.common.groupsandstores.filter((v: any) => v.sg_id == this.groupId)[0].Stores;
        this.storeIds.length == this.stores.length ? this.groupName = this.stores[0].sg_Name : this.groupName = ''
        this.storeIds.length == 1 ? this.storename = this.stores.filter((e: any) => e.ID == this.storeIds)[0].storename : this.storename = ''
        this.getStoresandGroupsValues()
      }

      if (localStorage.getItem('stime') != null) {
        let stime = localStorage.getItem('stime');
        if (stime != null && stime != '') {
          this.initializeDates(stime)
          this.DateType = stime
        }
      } else {
        this.initializeDates('MTD')
        this.DateType = 'MTD'
      }
      localStorage.setItem('stime', 'MTD')

    }
    this.shared.setTitle(this.shared.common.titleName + '-F&I Manager Ranking');
    if (typeof window !== 'undefined') {

      // if (localStorage.getItem('Fav') != 'Y') {
      const data = {
        title: 'F&I Manager Rankings',
        path1: '',
        path2: '',
        path3: '',
        stores: this.storeIds,
        toporbottom: this.TotalReport,
        datetype: '',
        fromdate: this.FromDate,
        todate: this.ToDate,
        groups: this.groups,
        storeorgroup: this.storeorgrp,
        dealType: this.dealType,
        saleType: this.saleType,
        financeType: this.financeType,
        count: 0
      };
      this.shared.api.SetHeaderData({
        obj: data,
      });
      this.header = [{
        type: 'Bar', storeIds: this.storeIds, storeorgroup: this.storeorgrp, dealType: this.dealType,
        saleType: this.saleType,
        financeType: this.financeType, groups: this.groups
      }]

      this.GetData('Rank', 'asc');
      this.setDates(this.DateType)

      // } else {
      //   this.getFavReports();
      // }
    }
  }

  ngOnInit(): void {
    // if (typeof window !== 'undefined') {

    // localStorage.setItem('time', this.dateType);

    // }
    // // var curl = 'https://fbxtract.axelautomotive.com/favouritereports/GetFIManagerRankings';
    // // this.apiSrvc.logSaving(curl,{},'','Success','F&I Manager Rankings');
  }
  // private initializeDates() {
  //   const today = new Date();
  //   const enddate = new Date(today.setDate(today.getDate() - 1));

  //   this.FromDate = `${('0' + (enddate.getMonth() + 1)).slice(-2)}/01/${enddate.getFullYear()}`;
  //   this.ToDate = `${('0' + (enddate.getMonth() + 1)).slice(-2)}/${('0' + enddate.getDate()).slice(
  //     -2
  //   )}/${enddate.getFullYear()}`;
  // }


    setDates(type: any) {
    // localStorage.setItem('time', type);
    // this.datevaluetype=
    // console.log(type);

    this.displaytime = 'Time Frame (' + this.Dates.Types.filter((val: any) => val.code == type)[0].name + ')';
    this.maxDate = new Date();
    this.minDate = new Date();
    this.minDate.setFullYear(this.maxDate.getFullYear() - 3);
    this.maxDate.setDate(this.maxDate.getDate());
    this.Dates.FromDate = this.FromDate;
    this.Dates.ToDate = this.ToDate;
    this.Dates.MinDate = this.minDate;
    this.Dates.MaxDate = this.maxDate;
    this.Dates.DateType = this.DateType;
    this.Dates.DisplayTime = this.displaytime;
  }

  GetData(sortdata?: any, sortstate?: any) {
    this.FIManagerData = [];
    this.shared.spinner.show();
    const obj = {
      StartDate: this.FromDate,
      EndDate: this.ToDate,
      StoreID: this.storeIds,
      Exp: sortdata,
      OrderType: sortstate,
      RankBy: this.storeorgrp,
      UserID: 0,
      SaleType: this.neworused.toString(),
      DealType: this.retailorlease.toString(),
      FinanceType: this.financetype.toString(),
    };
    let startFrom = new Date().getTime();
    const curl = this.shared.getEnviUrl() + 'cavender/GetFIManagerRankings';
    this.shared.api.postmethod(this.shared.common.routeEndpoint + 'GetFIManagerRankings', obj).subscribe(
      (res: { message: any; status: number; response: string | any[] | undefined; }) => {
        const currentTitle = document.title;
        this.shared.api.logSaving(curl, {}, '', res.message, currentTitle);
        if (res.status == 200) {
          if (res.response != undefined) {
            if (res.response.length > 0) {
              let resTime = (new Date().getTime() - startFrom) / 1000;
              // this.logSaving(
              //   this.solutionurl + 'cavender/GetFIManagerRankings',
              //   obj,
              //   resTime,
              //   'Success'
              // );
              this.FIManagerData = res.response;
              this.shared.spinner.hide();
              this.NoData = false;
              // this.FIManagerData.some(function (x: any) {
              //   x.Data2 = JSON.parse(x.Data2);
              //   x.Dealerx = '+';
              //   return false;
              // });
              // this.GetTotalData();
              let position = this.scrollCurrentposition + 5
              setTimeout(() => {
                if (this.scrollcent)
                  this.scrollcent.nativeElement.scrollTop = position
                // //console.log(position);

              }, 500);
            } else {
              // this.toast.error('Empty Response', '');
              this.shared.spinner.hide();
              this.NoData = true;
            }
          } else {
            let resTime = (new Date().getTime() - startFrom) / 1000;
            // this.logSaving(
            //   this.solutionurl + 'cavender/GetFIManagerRankings',
            //   obj,
            //   resTime,
            //   'Error'
            // );
            // this.shared.toast.error(res.status, '');

            this.shared.spinner.hide();
            this.NoData = true;
          }
        } else {
          // this.toast.error(res.status, '');
          this.shared.spinner.hide();
          this.NoData = true;
        }
      },
      (error: any) => {
        // this.toast.error('502 Bad Gate Way Error', '');
        this.shared.spinner.hide();
        this.NoData = true;
      }
    );
  }
  openDetails(data: any) {
    const DetailsSalesPeron = this.shared.ngbmodal.open(
      // SalesgrossDetailsComponent,
      {
        size: 'xxl',
        backdrop: 'static',
      }
    );
    DetailsSalesPeron.componentInstance.Salesdetails = [
      {
        StartDate: this.FromDate,
        EndDate: this.ToDate,
        dealtype: this.dealType,
        saletype: this.saleType,
        dealstatus: [
          "Delivered",
          "Capped",
          "Finalized"
        ],
        var1: 'store',
        var2: 'fimanager',
        var3: '',
        var1Value: data.StoreName,
        var2Value: data.FITrimName,
        var3Value: '',
        userName: data.FITrimName,
        FinanceManager: "0",
        SalesManager: "0",
        SalesPerson: "0"
      },
    ];
    DetailsSalesPeron.result.then(
      (data: any) => { },
      (reason: any) => {
        // on dismiss
      }
    );
  }
  // GetTotalData() {
  //   this.TotalSalesPersonsData = [];
  //   const obj = {
  //     AU_ID: '69',
  //     AS_ID: this.storeIds,
  //     StartDate: this.FromDate,
  //     EndDate: this.ToDate,
  //     OrderBy: 'TR',
  //     type: 'T',
  //   };
  //   this.apiSrvc
  //     .postmethod(this.comm.routeEndpoint+'GetFIManagerRankings', obj)
  //     .subscribe(
  //       (totalres) => {
  //         if (totalres.status == 200) {
  //           this.TotalSalesPersonsData = totalres.response.map((v) => ({
  //             ...v,
  //             Data2: [],
  //           }));
  //           this.spinner.hide();
  //           if (this.TotalSalesPersonsData.length > 0) {
  //             this.TotalSalesPersonsData.some(function (x: any) {
  //               x.data1 = 'Reports Total';
  //             });
  //             if (this.TotalReport == 'B') {
  //               this.FIManagerData.push(
  //                 this.TotalSalesPersonsData[0]
  //               );
  //             } else {
  //               this.FIManagerData.unshift(
  //                 this.TotalSalesPersonsData[0]
  //               );
  //             }
  //           }

  //           this.SalesPersonsData = [];

  //           this.SalesPersonsData = this.FIManagerData;
  //           // //console.log(this.SalesData)
  //           // this.spinner.hide()
  //           //   if(this.SalesPersonsData.length>0){
  //           //      this.SalesPersonsData.some(function(x:any){
  //           //        if(x.data1 != 'Reports Total'){
  //           //      if(x.Data2 != undefined){
  //           //       x.Data2=JSON.parse(x.Data2);
  //           //       x.Data2=x.Data2.map(v => ({ ...v, SubData:[],data2sign:'-' }))

  //           //                    }

  //           //                    if(x.Data3 != undefined){
  //           //                     x.Data3=JSON.parse(x.Data3);

  //           //                     x.Data2.forEach(val=>{

  //           //                       x.Data3.forEach(ele=>{
  //           //                         if(val.data2==ele.data2){
  //           //                           val.SubData.push(ele)
  //           //                         }
  //           //                       })
  //           //                     })
  //           //                    }
  //           //        }
  //           //     x.Dealer ='+';
  //           //     return false;
  //           //   });
  //           // }
  //           if (this.SalesPersonsData.length == 0) {
  //             this.NoData = true;
  //           } else {
  //             this.NoData = false;
  //           }
  //         } else {
  //           alert('Invalid Details');
  //         }
  //       },
  //       (error) => {
  //         //console.log(error);
  //       }
  //     );
  // }

  public inTheGreen(value: number): boolean {
    if (value >= 0) {
      return true;
    }
    return false;
  }
  reportOpen(temp: any) {


    // this.shared.ngbmodalActive = this.shared.ngbmodal.open(temp, {
    //   size: 'xl',
    //   backdrop: 'static',
    // });
  }
  expandorcollapse(ind: any, e: any, ref: any, Item: any) {
    let id = (e.target as Element).id;
    if (id == 'D_' + ind) {
      if (ref == '-') {
        Item.Dealerx = '+';
      }
      if (ref == '+') {
        Item.Dealerx = '-';
      }
    }
  }

  isDesc: boolean = false;
  column: string = 'CategoryName';
  sort(property: any) {
    this.isDesc = !this.isDesc; //change the direction
    this.column = property;
    let direction = this.isDesc ? 1 : -1;
    if (this.TotalReport == 'T') {
      var arr = this.FIManagerData.slice(1, this.FIManagerData.length);
      arr.sort(function (a: any, b: any) {
        if (a[property] < b[property]) {
          return -1 * direction;
        } else if (a[property] > b[property]) {
          return 1 * direction;
        } else {
          return 0;
        }
      });
      arr.unshift(this.FIManagerData[0]);
      this.FIManagerData = arr;
    } else {
      var arr = this.FIManagerData.slice(0, -1);
      arr.sort(function (a: any, b: any) {
        if (a[property] < b[property]) {
          return -1 * direction;
        } else if (a[property] > b[property]) {
          return 1 * direction;
        } else {
          return 0;
        }
      });
      arr.push(this.FIManagerData[this.FIManagerData.length - 1]);
      this.FIManagerData = arr;
    }
  }
  FIMstate: any;
  tabClick(col_Name: any) {

    // First click on a column
    if (this.columnName !== col_Name) {
      this.columnName = col_Name;
      this.columnState = 'asc';   // ðŸ‘ˆ start with ASC on first click
    }
    // Clicking same column again â†’ toggle
    else {
      this.columnState = this.columnState === 'asc' ? 'desc' : 'asc';
    }
  
    this.GetData(this.columnName, this.columnState);
  }
  

  ngChanges: any = []
  ngOnChanges(changes: SimpleChanges) {
    console.log(changes, 'Report');
    this.ngChanges = changes['header'].currentValue[0];
    this.FromDate = this.ngChanges.fromDate;
    this.ToDate = this.ngChanges.toDate;
    this.neworused = this.ngChanges.dealType;
    this.retailorlease = this.ngChanges.saleType;
    // this.dealstatus = this.ngChanges.dealStatus;
    // this.setDates(this.ngChanges.datevaluetype)

  }
  ngAfterViewInit(): void {
    this.shared.api.getStores().subscribe((res: any) => {
      if (this.shared.common.pageName == 'F&I Manager Rankings') {
       if (res.obj.storesData != undefined) {
          this.groupsArray = res.obj.storesData;
          this.stores = this.shared.common.groupsandstores.filter((v: any) => v.sg_id == this.groupId)[0].Stores;
          this.storeIds.length == this.stores.length ? this.groupName = this.stores[0].sg_name : this.groupName = ''
          this.storeIds.length == 1 ? this.storename = this.stores.filter((e: any) => e.ID == this.storeIds)[0].storename : this.storename = ''
          this.getStoresandGroupsValues()
        }
      }
    })
    this.shared.api.GetReportOpening().subscribe((res: { obj: { Module: string; }; }) => {
      // //console.log(res);
      if (res.obj.Module == 'F&I Manager Rankings') {
        document.getElementById('report')?.click()
      }
    });
    this.shared.api.GetReports().subscribe((data: { obj: { Reference: string; header: string | undefined; storeValues: any; TotalReport: any; storeorgroup: any; groups: any; FromDate: undefined; ToDate: undefined; dateType: any; dealType: any; saleType: any; financeType: any; }; }) => {
      if (data.obj.Reference == 'F&I Manager Rankings') {
        if (data.obj.header == undefined) {
          this.storeIds = data.obj.storeValues;
          this.TotalReport = data.obj.TotalReport;
          this.storeorgrp = data.obj.storeorgroup;
          this.groups = data.obj.groups
          if (data.obj.FromDate != undefined && data.obj.ToDate != undefined) {
            this.FromDate = data.obj.FromDate;
            this.ToDate = data.obj.ToDate;
            this.storeIds = data.obj.storeValues;
            this.dateType = data.obj.dateType;
            this.dealType = data.obj.dealType;
            this.saleType = data.obj.saleType;
            this.financeType = data.obj.financeType;
            this.storeorgrp == 'G' && (this.columnName != 'Rank' && this.columnName != 'fimanager' && this.columnName != 'StoreName') ? this.columnState = 'asc' : '';
            this.GetData(this.columnName, this.columnState);
          } else {
            this.FromDate = data.obj.FromDate;
            this.ToDate = data.obj.ToDate;
            this.storeIds = data.obj.storeValues;
            this.dateType = data.obj.dateType;
            this.dealType = data.obj.dealType;
            this.saleType = data.obj.saleType;
            this.financeType = data.obj.financeType;
            this.storeorgrp == 'G' && (this.columnName != 'Rank' && this.columnName != 'fimanager' && this.columnName != 'StoreName') ? this.columnState = 'asc' : '';

            this.GetData(this.columnName, this.columnState);
          }
        }
        else {
          if (data.obj.header == 'Yes') {
            this.storeIds = data.obj.storeValues;
            //console.log(this.storeIds);
            this.GetData(this.columnName, this.columnState);
          }
        }
        const headerdata = {
          title: 'F&I Manager Rankings',
          path1: '',
          path2: '',
          path3: '',
          stores: this.storeIds,
          toporbottom: this.TotalReport,
          datetype: this.dateType,
          fromdate: this.FromDate,
          todate: this.ToDate,
          groups: this.groups,
          storeorgroup: this.storeorgrp,
          dealType: this.dealType,
          saleType: this.saleType,
          financeType: this.financeType,
        };
        this.shared.api.SetHeaderData({
          obj: headerdata,
        });
        this.header = [{
          type: 'Bar', storeIds: this.storeIds, storeorgroup: this.storeorgrp, dealType: this.dealType,
          saleType: this.saleType,
          financeType: this.financeType, groups: this.groups
        }]
      }
    });
    this.shared.api.getExportToExcelAllReports().subscribe((res: { obj: { state: boolean; title: string; }; }) => {
      this.FIMstate = res.obj.state;
      if (res.obj.title == 'F&I Manager Rankings') {
        if (res.obj.state == true) {
          this.exportToExcel();
        }
      }
    });

    this.shared.api.getExportToEmailPDFAllReports().subscribe((res: { obj: { title: string; stateEmailPdf: boolean; }; }) => {
      if (res.obj.title == 'F&I Manager Rankings') {
        if (res.obj.stateEmailPdf == true) {
          // this.sendEmailData(res.obj.Email, res.obj.notes, res.obj.from);
        }
      }
    });
    this.shared.api.getExportToPrintAllReports().subscribe((res: { obj: { title: string; statePrint: boolean; }; }) => {
      if (res.obj.title == 'F&I Manager Rankings') {
        if (res.obj.statePrint == true) {
          // this.GetPrintData();
        }
      }
    });
    this.shared.api.getExportToPDFAllReports().subscribe((res: { obj: { title: string; statePDF: boolean; }; }) => {
      if (res.obj.title == 'F&I Manager Rankings') {
        if (res.obj.statePDF == true) {
          // this.generatePDF();
        }
      }
    });
  }

  // displaytime() {
  //   if (this.DateType == 'PM') {
  //     return 'Time Frame (Same Month PY)';
  //   }
  //   else if (this.DateType == 'LM') {
  //     return 'Time Frame (Last Month)';
  //   }
  //   else if (this.DateType == 'LY') {
  //     return 'Time Frame (Last Year)';
  //   }
  //   else if (this.DateType == 'C') {
  //     return this.shared.datePipe.transform(this.FromDate, 'MM.dd.yyyy') + ' - ' + this.shared.datePipe.transform(this.ToDate, 'MM.dd.yyyy')
  //   }
  //   return 'Time Frame (' + this.DateType + ')';
  // }

  StoresData(data: any) {
    this.storeIds = data.storeids;
    this.groupId = data.groupId;
    this.storename = data.storename;
    this.groupName = data.groupName;
    this.storecount = data.storecount;
    this.storedisplayname = data.storedisplayname;
  }


  // openDetails(Item) {
  //   this.CompleteComponentState = false;
  //   const DetailsSalesPeron = this.ngbmodal.open(SalespersonsDealsComponent, {
  //     // size:'xl',
  //     backdrop: 'static',
  //   });
  //   DetailsSalesPeron.componentInstance.Dealdetails = Item;
  //   DetailsSalesPeron.result.then(
  //     (data) => {},
  //     (reason) => {
  //       // on dismiss
  //       this.CompleteComponentState = true;
  //     }
  //   );
  // }

  Scrollpercent: any = 0;
  scrollCurrentposition: any = 0
  @ViewChild('scrollcent') scrollcent!: ElementRef;

  updateVerticalScroll(event: any): void {

    this.scrollCurrentposition = event.target.scrollTop
    const scrollDemo = document.querySelector('#scrollcent') as HTMLElement;
    this.Scrollpercent = Math.round(
      (event.target.scrollTop /
        (event.target.scrollHeight - scrollDemo.clientHeight)) *
      100
    );
  }

  selBlock: any;
  commentopen(item: any, i: any, slblock: any = '') {
    this.index = '';
    //console.log('Selected Obj :', item);
    //return
    this.selBlock = slblock + i.toString();
    this.index = i.toString();
    this.commentobj = {
      TYPE: item.fimanager,
      NAME: item.fimanager,
      STORES: item.StoreName,
      STORENAME: item.StoreName,
      Month: '',
      ModuleId: '24',
      ModuleRef: 'FIMR',
      state: 1,
      indexval: i,
    };


    // const DetailsSF = this.ngbmodal.open(CommentsComponent, {
    //   size: 'xl',
    //   backdrop: 'static',
    // });
    // DetailsSF.componentInstance.SFComments = {
    //   TYPE: item.LABLEVAL,
    //   NAME: item.LABLE,
    //   STORES: this.selectedstorevalues,
    //   LatestDate: this.Month,
    //   STORENAME: this.selectedstorename,
    //   Month: this.Month,
    //   ModuleId: '66',
    //   ModuleRef: 'SF',
    // };
    // DetailsSF.result.then(
    //   (data) => {},
    //   (reason) => {
    //     // alert('close');
    //     // // on dismiss
    //     // const Data = {
    //     //   state: true,
    //     // };
    //     // this.apiSrvc.setBackgroundstate({ obj: Data });
    //     this.GetData();
    //   }
    // );
    //alert(this.index);
  }


  index = '';
  commentobj: any = {};

  addcmt(data: any) {
    if (data == 'A') {
      this.index = '';
      const DetailsSF = this.shared.ngbmodal.open({
        size: 'xl',
        backdrop: 'static',
      });
      // myObject['skillItem2'] = 15;
      this.commentobj['state'] = 0;
      (DetailsSF.componentInstance.SFComments = this.commentobj),
        DetailsSF.result.then(
          (data: any) => {
            // //console.log(data);
          },
          (reason: string) => {
            // //console.log(reason);

            if (reason == 'O') {
              this.commentobj['state'] = 1;
              this.index = this.commentobj['indexval'];
            } else {
              this.commentobj['state'] = 1;
              this.index = this.commentobj['indexval'];

              this.GetData(this.columnName, this.columnState);

            }
            // // on dismiss

            // const Data = {
            //   state: true,
            // };
            // this.apiSrvc.setBackgroundstate({ obj: Data });
            // this.GetData();
          }
        );
    }
    if (data == 'AD') {

      this.GetData(this.columnName, this.columnState);

    }
  }
  // close(data: any) {
  //   // //console.log(data);
  //   this.index = '';
  // }


  //////////////////////  REPORT CODE /////////////////////////////////////////////
  // === State used in HTML ===
  Bar: boolean = true;
  activePopover: number = -1;
  neworused: string[] = ['New', 'Used'];


  //  stores: any[] = [];
  selectedstorevalues: any[] = [];
  storeName: string = '';
  //  groupName: string = '';
  // groups: any[] = [];
  selectedGroups: any[] = [];
  AllStores: boolean = true;
  AllGroups: boolean = true;

  storeorgroup: any = ['G'];
  retailorlease: any = ['Retail', 'Lease', 'Misc', 'Special Order'];
  financetype: any = ['Finance', 'Cash', 'Lease'];

  // constructor(private pipe: DatePipe) {}

  // === HTML Interactions ===
  // @HostListener('document:click', ['$event'])
  // onDocumentClick(event: MouseEvent) {
  //   const clickedInside = (event.target as HTMLElement).closest('.dropdown-toggle, .reportstores-card, .timeframe');
  //   if (!clickedInside) {
  //     this.activePopover = -1;
  //   }
  // }
  @HostListener('document:click', ['$event'])
  onDocumentClick(event: MouseEvent) {
    const clickedInside = (event.target as HTMLElement).closest('.dropdown-toggle, .reportstores-card, .timeframe');
    if (!clickedInside) {
      this.activePopover = -1;
    }
  }
  togglePopover(popoverIndex: number) {
    if (this.activePopover === popoverIndex) {
      this.activePopover = -1;
    } else {
      this.activePopover = popoverIndex;
    }
  }
   getStoresandGroupsValues() {
    this.storesFilterData.groupsArray = this.groupsArray;
    this.storesFilterData.groupId = this.groupId;
    this.storesFilterData.storesArray = this.stores;
    this.storesFilterData.storeids = this.storeIds;
    this.storesFilterData.groupName = this.groupName;
    this.storesFilterData.storename = this.storename;
    this.storesFilterData.storecount = this.storecount;
    this.storesFilterData.storedisplayname = this.storedisplayname;

    this.storesFilterData = {
      groupsArray: this.groupsArray,
      groupId: this.groupId,
      storesArray: this.stores,
      storeids: this.storeIds,
      groupName: this.groupName,
      storename: this.storename,
      storecount: this.storecount,
      storedisplayname: this.storedisplayname,
      'type': 'M', 'others': 'N'
    };

    // this.setHeaderData();
    // this.GetData();

  }

  // Store selection
  allstores() {
    this.AllStores = !this.AllStores;
    this.selectedstorevalues = this.AllStores ? this.stores.map((s: { ID: any; }) => s.ID) : [];
  }


  individualStores(e: any) {

    const index = this.selectedstorevalues.findIndex((i: any) => i == e.ID);
    if (index >= 0) {
      this.selectedstorevalues.splice(index, 1);
      this.AllStores = false;
      if (this.selectedstorevalues.length == 1) {
        this.storeorgroup = 'S'
      }
      else {
        this.storeorgroup = 'G'
      }

    } else {
      this.selectedstorevalues.push(e.ID);
      if (this.selectedstorevalues.length == 1) {
        this.storeorgroup = 'S'
      }
      else {
        this.storeorgroup = 'G'
      }
      if (this.selectedstorevalues.length == this.stores.length) {
        this.AllStores = true;
      } else {
        this.AllStores = false;
      }
    }
    if (this.selectedstorevalues.length == 1) {
      this.storeName = this.stores.filter((val: any) => val.ID == this.selectedstorevalues.toString())[0].storename
    }
  }
  // Group selection
  allgroups() {
    this.AllGroups = !this.AllGroups;
    this.selectedGroups = this.AllGroups ? this.groups.map((g: { sg_id: any; }) => g.sg_id) : [];
  }

  individualgroups(g: any) {
    this.selectedGroups = [g.sg_id];
    this.groupName = g.sg_name;
    this.storeorgroup = g.sg_id === 1 ? 'S' : 'G';
  }

  // Deal type & status
  multipleorsingle(block: string, val: string) {
    if (block === 'NU') {

      this.toggleSelection(this.neworused, val);

    }

    if (block === 'RL') {
      this.toggleSelection(this.retailorlease, val);
    }
    if (block === 'DS') {
      this.toggleSelection(this.financetype, val);
    }
  }

  private toggleSelection(arr: any[], val: string) {
    const idx = arr.indexOf(val);
    if (idx >= 0) {
      arr.splice(idx, 1);
    } else {
      arr.push(val);
    }
  }

  storeorgroups(_block: any, val: string) {
    this.storeorgroup = [val];
  }


  initializeDates(type: any) {
    let dates: any = this.setdates.setDates(type)
    this.FromDate = dates[0];
    this.ToDate = dates[1];
    localStorage.setItem('time', type);
  }

  openCustomPicker(datepicker: any) {
    this.DateType = 'C';
    localStorage.setItem('time', this.DateType);
    datepicker.toggle();
  }


  dateRangeCreated($event: any) {
    if ($event) {
      this.FromDate = this.shared.datePipe.transform($event[0], 'MM-dd-yyyy');
      this.ToDate = this.shared.datePipe.transform($event[1], 'MM-dd-yyyy');
      this.bsRangeValue = [this.FromDate, this.ToDate];
      if (this.DateType === 'C') this.custom = true;
    }
  }

  updatedDates(data: any) {
    // console.log(data);
    this.FromDate = data.FromDate;
    this.ToDate = data.ToDate;
    this.DateType = data.DateType;
    this.displaytime = data.DisplayTime
  }


  close() {
    this.shared.ngbmodal.dismissAll();
  }

  // Final Apply
  viewreport() {
    this.activePopover = -1;
    console.log('Apply clicked with:', {
      FromDate: this.FromDate,
      ToDate: this.ToDate,
      Stores: this.selectedstorevalues,
      Groups: this.selectedGroups,
      StoreOrGroup: this.storeorgroup,
      // SaleType: this.retailorlease,
      financetype: this.financetype,

      dealType: this.dealType,
      saleType: this.saleType,
      financeType: this.financeType
    });


    if (this.storeIds.length === 0) {
      alert('Please select any store');
    }
    else if (this.retailorlease.length == 0) {
      alert('Please select any one Deal Type');
    }
    else if (this.neworused.length == 0) {
      alert('Please select atleast one Sale Type');
    }
    else if (this.financetype.length == 0) {
      alert('Please select atleast one Finance Type');
    }
    else {
      const data = {
        Reference: 'F&I Manager Ranking',
        FromDate: this.FromDate,
        ToDate: this.ToDate,
        // TotalReport: this.toporbottom[0],
        storeValues: this.selectedstorevalues.toString(),
        // == '' ? '0': this.selectedstorevalues.toString(),
        dateType: this.DateType,
        groups: this.selectedGroups.toString(),
        storeorgroup: this.storeorgroup.toString(),
        // saleType: this.retailorlease.toString(),
        financetype: this.financetype,
        dealType: this.dealType,
        saleType: this.saleType
      };
      this.shared.api.SetReports({
        obj: data,
      });
      this.close();
      this.GetData(this.columnName, this.columnState);


    }

  }

  exportToExcel(): void {
    const workbook = this.shared.getWorkbook();
    const worksheet = workbook.addWorksheet('F&I Manager Rankings');
    const title = worksheet.addRow(['F&I Manager Rankings']);
    title.font = { size: 14, bold: true, name: 'Arial' };
    title.alignment = { vertical: 'middle', horizontal: 'center' };
    worksheet.mergeCells('A1:J1');
    worksheet.addRow([]);
    const formattedFromDate = this.shared.datePipe.transform(this.FromDate, 'dd-MMM-yyyy');
    const formattedToDate = this.shared.datePipe.transform(this.ToDate, 'dd-MMM-yyyy');
 // ===== STORE VALUE FOR EXCEL (FROM UI SELECTION) =====

let storeValue = '';

const selectedStoreIds: string[] =
  this.storeIds && this.storeIds.length
    ? this.storeIds.map((id: any) => id.toString())
    : [];

const allStores: any[] = Array.isArray(this.stores) ? this.stores : [];

// âœ… Bind ONLY selected store names
storeValue = allStores
  .filter((s: any) => selectedStoreIds.includes(s.ID.toString()))
  .map((s: any) => s.storename.trim())
  .filter(Boolean)
  .join(', ');

// âœ… Final fallback (safety)
if (!storeValue && selectedStoreIds.length) {
  storeValue = selectedStoreIds.join(', ');
}

    const filters = [
      { name: 'Store:', values: storeValue },
      { name: 'Time Frame:', values: `${formattedFromDate} to ${formattedToDate}` },
      { name: 'Rank By:', values: this.storeorgroup == 'S' ? 'Store' : 'Group' },
      { name: 'New/Used:', values: this.neworused || 'All' },
      { name: 'Deal Type:', values: this.retailorlease || 'All' },
      { name: 'Finance Type:', values: this.financetype || 'All' },
    ];




    let currentRow = worksheet.lastRow?.number ?? worksheet.rowCount;
    filters.forEach((filter) => {
      currentRow++;

      let value = Array.isArray(filter.values)
        ? filter.values.join(', ')
        : filter.values;

      const row = worksheet.addRow([filter.name, value]);
      row.getCell(1).font = { bold: true, name: 'Arial', size: 10 };
      row.getCell(2).font = { name: 'Arial', size: 10, color: { argb: 'FF1F497D' } }; // blue color for values
      worksheet.mergeCells(`B${currentRow}:F${currentRow}`);
    });

    worksheet.addRow([]);


    const firstHeader = ['', '', '', 'Back Gross', '', '', 'Unit Count', '', ''];
    const headerRow1 = worksheet.addRow(firstHeader);


    const secondHeader = [
      'Rank', 'Finance Manager', 'Store Name',
      'PVR', 'Gross', 'Pace',
      'New', 'Used', 'Total', 'Pace'
    ];
    const headerRow2 = worksheet.addRow(secondHeader);

    const headerRow1Index = headerRow1.number;
    const headerRow2Index = headerRow2.number;


    worksheet.mergeCells(`A${headerRow1Index}`);
    worksheet.mergeCells(`B${headerRow1Index}`);
    worksheet.mergeCells(`C${headerRow1Index}`);
    worksheet.mergeCells(`D${headerRow1Index}:F${headerRow1Index}`); // Back Gross
    worksheet.mergeCells(`G${headerRow1Index}:J${headerRow1Index}`); // Unit Count


    [headerRow1, headerRow2].forEach(r => {
      r.height = 22;
      r.eachCell({ includeEmpty: false }, (cell) => {
        cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.fill = {
          type: 'pattern',
          pattern: 'solid',
          fgColor: { argb: 'FF2F5597' }, // deep blue
        };
      });
    });


    const bindingHeaders = [
      'Rank', 'fimanager', 'StoreName',
      'BackgrossPVR', 'BackGross',
      'BackGrossPace', 'New', 'Used', 'Total', 'Pace'
    ];

    const currencyFields = ['BackgrossPVR', 'BackGross',
      'BackGrossPace'];

    this.FIManagerData.forEach((info: any) => {
      const rowData = bindingHeaders.map((key) => {
        const val = info[key];
        return (val === 0 || val == null || val === '') ? '-' : val;
      });

      const dataRow = worksheet.addRow(rowData);

      bindingHeaders.forEach((key, index) => {
        const cell = dataRow.getCell(index + 1);

        if (currencyFields.includes(key) && typeof cell.value === 'number') {
          cell.numFmt = '"$"#,##0.00';
          cell.alignment = { horizontal: 'right', vertical: 'middle' };
        } else {
          cell.alignment = { horizontal: 'center', vertical: 'middle' };
        }
      });
    });


    worksheet.columns.forEach(col => col.width = 25);


    workbook.xlsx.writeBuffer().then(buffer => {
      this.shared.exportToExcel(workbook, 'F&I Manager Rankings');
    });
  }


}

